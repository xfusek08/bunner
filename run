#!/bin/sh

# Bunner Runner
# =============
# This script runs bunner commands either natively or in a Docker container.
#
# Configuration:
# - BUNNER_NATIVE: Set to "true" to run natively (requires bun installed)
# - BUNNER_ENV_VARS: Space-separated list of environment variable names
#   to pass into the Docker container (e.g., "VAR1 VAR2 VAR3")
# - BUNNER_VOLUMES: Space-separated list of additional paths to mount
#   into the Docker container (e.g., "/path/one /path/two")

run_native() {
    #------------------------------------------------------
    # Run bunner natively using system bun
    #------------------------------------------------------
    local thisScriptFileLocation=$(readlink -f "$0")
    thisScriptFileLocation=$(dirname "$thisScriptFileLocation")

    local commandsDirectory=""
    if [ -n "$1" ]; then
        commandsDirectory="$1"
        shift
        commandsDirectory=$(readlink -f "$commandsDirectory")
    fi

    export BUNNER_ENTRY_POINT_DIRECTORY="$thisScriptFileLocation"

    bun "$thisScriptFileLocation/entry.ts" ${commandsDirectory:+"$commandsDirectory"} "$@"
}

run_in_bun_docker() {
    #------------------------------------------------------
    # Setup paths and directories
    #------------------------------------------------------
    # Get absolute path of this script file no matter where it was sourced or called from
    local thisScriptFileLocation=$(readlink -f "$0")
    thisScriptFileLocation=$(dirname "$thisScriptFileLocation")

    local directory="$(pwd)"

    #------------------------------------------------------
    # Build Docker image if it doesn't exist
    #------------------------------------------------------
    if ! docker image inspect bun-docker-alpine:latest > /dev/null 2>&1; then
        echo "Building bun-docker-alpine image..."
        cd "$thisScriptFileLocation"
        docker build -t bun-docker-alpine:latest -f Dockerfile .
        cd "$directory"
    fi

    #------------------------------------------------------
    # Setup Docker socket permissions
    #------------------------------------------------------
    # Get host's Docker socket group ID
    DOCKER_GID=$(stat -c '%g' /var/run/docker.sock 2> /dev/null || echo 0)

    #------------------------------------------------------
    # Setup commands directory (if provided)
    #------------------------------------------------------
    local commandsDirectory=""
    if [ -n "$1" ]; then
        commandsDirectory="$1"
        shift
        commandsDirectory=$(readlink -f "$commandsDirectory")
    fi

    #------------------------------------------------------
    # Determine container name (bunner, bunner_1, bunner_2, etc.)
    #------------------------------------------------------
    local container_name="bunner"
    local counter=1

    while docker container inspect "$container_name" > /dev/null 2>&1; do
        container_name="bunner_$counter"
        counter=$((counter + 1))
    done

    #------------------------------------------------------
    # Check if stdin is a TTY for interactive mode
    #------------------------------------------------------
    if [ -t 0 ]; then
        # Interactive mode - include tty and interactive flags
        INTERACTIVE_FLAGS="--interactive --tty"
    else
        # Non-interactive mode - skip tty and interactive flags
        INTERACTIVE_FLAGS=""
    fi

    #------------------------------------------------------
    # Build environment variable flags from BUNNER_ENV_VARS
    #------------------------------------------------------
    # BUNNER_ENV_VARS should be a space-separated list of variable names
    # that should be passed to the Docker container
    local ENV_FLAGS=""
    if [ -n "$BUNNER_ENV_VARS" ]; then
        for var in $BUNNER_ENV_VARS; do
            # Use indirect variable expansion for POSIX sh compatibility
            eval "local value=\$$var"
            if [ -n "$value" ]; then
                ENV_FLAGS="$ENV_FLAGS --env $var=$value"
            fi
        done
    fi

    #------------------------------------------------------
    # Build volume mount flags from BUNNER_VOLUMES
    #------------------------------------------------------
    # BUNNER_VOLUMES should be a space-separated list of paths
    # that should be mounted into the Docker container
    local VOLUME_FLAGS=""
    if [ -n "$BUNNER_VOLUMES" ]; then
        for vol in $BUNNER_VOLUMES; do
            if [ -e "$vol" ]; then
                VOLUME_FLAGS="$VOLUME_FLAGS --volume $vol:$vol"
            fi
        done
    fi

    #------------------------------------------------------
    # Run Bun in Docker container
    #------------------------------------------------------
    docker run \
        --init \
        $INTERACTIVE_FLAGS \
        --rm \
        --name "$container_name" \
        --env TERM="$TERM" \
        --env COLUMNS="${COLUMNS:-$(tput cols)}" \
        --env LINES="${LINES:-$(tput lines)}" \
        --env BUNNER_ENTRY_POINT_DIRECTORY="$thisScriptFileLocation" \
        --env HOME="$HOME" \
        $ENV_FLAGS \
        --volume "$directory:$directory" \
        --volume "$commandsDirectory:$commandsDirectory" \
        --volume "$thisScriptFileLocation:$thisScriptFileLocation" \
        --volume "$HOME:$HOME" \
        $VOLUME_FLAGS \
        --volume /var/run/docker.sock:/var/run/docker.sock \
        --group-add "$DOCKER_GID" \
        --workdir "$directory" \
        --user bun \
        --network host \
        bun-docker-alpine:latest \
        bun "$thisScriptFileLocation/entry.ts" ${commandsDirectory:+"$commandsDirectory"} "$@"
}

#------------------------------------------------------
# Main: Check mode and run accordingly
#------------------------------------------------------
if [ "$BUNNER_NATIVE" = "true" ]; then
    # Check if bun is installed
    if ! command -v bun > /dev/null 2>&1; then
        echo "Error: BUNNER_NATIVE is set but bun is not installed" >&2
        echo "Please install bun or unset BUNNER_NATIVE to use Docker mode" >&2
        exit 1
    fi
    run_native "$@"
else
    run_in_bun_docker "$@"
fi
