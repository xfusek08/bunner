#!/bin/sh

ensure_image() {
    if ! docker image inspect bun-docker-alpine:latest > /dev/null 2>&1; then
        echo "Building bun-docker-alpine image..."
        docker build -t bun-docker-alpine:latest -f Dockerfile .
    fi
}

run_in_bun_docker() {
    ensure_image
    
    local directory=$(pwd)
    
    # Get host's Docker socket group ID
    DOCKER_GID=$(stat -c '%g' /var/run/docker.sock 2>/dev/null || echo 0)

    docker run \
        --init \
        --interactive \
        --tty \
        --env TERM=$TERM \
        --rm \
        -e COLUMNS=${COLUMNS:-$(tput cols)} \
        -e LINES=${LINES:-$(tput lines)} \
        -v "$directory:$directory" \
        -v /var/run/docker.sock:/var/run/docker.sock \
        --group-add "$DOCKER_GID" \
        -w "$directory" \
        -u bun \
        bun-docker-alpine:latest \
        sh -c "bun bunner/entry.ts \"$@\""
}

run_in_bun_docker "$@"